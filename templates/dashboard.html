{% extends 'base.html' %}

{% block content %}

	<p>Dashboard</p>

	<form action="/set-chart-inputs" id="chart_inputs" method='POST'>
		Comp Set: 
			<select id="set_choice" name="comp_set_choice">
				<option value="{{ default_view.view_id }}"
					{{ 'selected' if default_view.view_id == session['set_choice'] else '' }}
				>{{ default_view.view_name }}
				{% for view in non_default_views %}
					<option value="{{ view.view_id }}"
						{{ 'selected' if view.view_id == session['set_choice'] else '' }}
					>{{ view.view_name }}
				{% endfor %}
			</select>
		Metric: 
			<select  id="metric_choice" name="metric_choice">
				{% for metric in metrics %}
					<option value="{{ metric }}"
					{{ 'selected' if metric == session['metric_choice'] else '' }}
				>{{ metric }}
				{% endfor %}
			</select>
		Timeframe:
			<select id="timeframe_choice" name="timeframe_choice">
				{% for timeframe in timeframes %}
					<option value="{{ timeframe }}"
						{{ 'selected' if timeframe == session['timeframe_choice'] else '' }}
					>{{ timeframe }}
				{% endfor %}
			</select><br>
		Competitors: 
		<div id="hotel_choices" name="hotel_choices">
			{% for hotel in hotels_in_view %}
				<input type="checkbox" class="hotel_choice" name="hotel" value="{{ hotel.hotel_id }}"
					{{ 'checked' if hotel.hotel_id in session['hotels_selection'] else '' }}
				>{{ hotel.hotel.hotel_name }}
			{% endfor %}
		</div>
	</form>

	<canvas id="myChart" width="200" height="100"></canvas>

{% endblock %}

{% block js %}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js"></script>
	<script>

	// chart stuff!
	// const ctx = document.getElementById('myChart');
	// const myChart = new Chart(ctx, {
	//     type: 'line',
	//     data: {
	//         labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
	//         datasets: [{
	//             label: '# of Votes',
	//             data: [12, 19, 3, 5, 2, 3],
	//             backgroundColor: [
	//                 'rgba(255, 99, 132, 0.2)',
	//                 'rgba(54, 162, 235, 0.2)',
	//                 'rgba(255, 206, 86, 0.2)',
	//                 'rgba(75, 192, 192, 0.2)',
	//                 'rgba(153, 102, 255, 0.2)',
	//                 'rgba(255, 159, 64, 0.2)'
	//             ],
	//             borderColor: [
	//                 'rgba(255, 99, 132, 1)',
	//                 'rgba(54, 162, 235, 1)',
	//                 'rgba(255, 206, 86, 1)',
	//                 'rgba(75, 192, 192, 1)',
	//                 'rgba(153, 102, 255, 1)',
	//                 'rgba(255, 159, 64, 1)'
	//             ],
	//             borderWidth: 1
	//         }]
	//     },
	//     options: {
	//         scales: {
	//             yAxes: [{
	//                 ticks: {
	//                     beginAtZero: true
	//                 }
	//             }]
	//         }
	//     }
	// });
		// this function pulls data from the form and sends it to route to get chart data
		// eventually the console.log(data) will push to chart.js
		function gatherDataFromForm() {
			
			const hotels = new Array();
			$("input:checkbox[name=hotel]:checked").each(function() {
				hotels.push($(this).val())
			});

			$.post('/set-chart-inputs', {
				'comp_set_choice' : $('#set_choice').val(),
				'metric_choice' : $('#metric_choice').val(),
				'timeframe_choice' : $('#timeframe_choice').val(),
				'hotels_selection' : hotels
				}, 
			(data) => {
				console.log(data)
			})
		}

		// Add event listeners to all elements of the form
		const form = document.querySelectorAll('#chart_inputs select, #chart_inputs input');

		for (const element of form) {
			element.addEventListener('change', gatherDataFromForm);
		}

		// Add a different event listener for comp set dropdowns
		const hotel_selector = document.querySelector('#set_choice');

		hotel_selector.addEventListener('change', () => {
			const comp_set_choice = $('#set_choice').val();
			$.get('/get-comp-set-hotels.json', {comp_set_choice: comp_set_choice}, (d) => {

				// this part of the function removes old comp set hotels and add new ones.
				// first select the div that has all the hotel choices
				const comp_set_div = document.querySelector('#hotel_choices');

				// change the innerHTML to nothing (this removes them all)
				comp_set_div.innerHTML = '';

				// for each view_hotel in data received recreate the element with each attribute
				for (const view_hotel of d) {
					const element = document.createElement('input');
					element.setAttribute('type', 'checkbox');
					element.setAttribute('class', 'hotel_choice');
					element.setAttribute('name', 'hotel');
					element.setAttribute('value', view_hotel.hotel.hotel_id);
					element.setAttribute('checked', '');

					// add the text part of the element (what actually displays to the user)
					const text = document.createTextNode(view_hotel.hotel.hotel_name);

					// add the element to the div so it actually shows up
					comp_set_div.appendChild(element);
					comp_set_div.appendChild(text);

					// add event listener again!
					element.addEventListener('change', gatherDataFromForm);
				}
			});
		});
		
	</script>

{% endblock %}

